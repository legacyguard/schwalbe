name: Test Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  test-secrets:
    name: Test Secrets Availability
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Repository Secrets
        run: |
          echo "ðŸ” Testing Repository Secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Test if secrets are available (not their values)
          [ ! -z "${{ secrets.GITHUB_TOKEN }}" ] && echo "âœ… GITHUB_TOKEN" || echo "âŒ GITHUB_TOKEN"
          [ ! -z "${{ secrets.TURBO_TOKEN }}" ] && echo "âœ… TURBO_TOKEN" || echo "âš ï¸  TURBO_TOKEN (optional)"
          [ ! -z "${{ secrets.TURBO_TEAM }}" ] && echo "âœ… TURBO_TEAM" || echo "âš ï¸  TURBO_TEAM (optional)"
      
      - name: Test Vercel Secrets
        run: |
          echo ""
          echo "ðŸ“¦ Testing Vercel Secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          [ ! -z "${{ secrets.VERCEL_TOKEN }}" ] && echo "âœ… VERCEL_TOKEN" || echo "âŒ VERCEL_TOKEN"
          [ ! -z "${{ secrets.VERCEL_ORG_ID }}" ] && echo "âœ… VERCEL_ORG_ID" || echo "âŒ VERCEL_ORG_ID"
          [ ! -z "${{ secrets.VERCEL_PROJECT_ID }}" ] && echo "âœ… VERCEL_PROJECT_ID" || echo "âŒ VERCEL_PROJECT_ID"
      
      - name: Test Supabase Secrets
        run: |
          echo ""
          echo "ðŸ—„ï¸ Testing Supabase Secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          [ ! -z "${{ secrets.VITE_SUPABASE_URL }}" ] && echo "âœ… VITE_SUPABASE_URL" || echo "âŒ VITE_SUPABASE_URL"
          [ ! -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ] && echo "âœ… VITE_SUPABASE_ANON_KEY" || echo "âŒ VITE_SUPABASE_ANON_KEY"
          [ ! -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ] && echo "âœ… SUPABASE_SERVICE_ROLE_KEY" || echo "âš ï¸  SUPABASE_SERVICE_ROLE_KEY (optional)"
      
      - name: Test Clerk Secrets
        run: |
          echo ""
          echo "ðŸ” Testing Clerk Secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          [ ! -z "${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}" ] && echo "âœ… VITE_CLERK_PUBLISHABLE_KEY" || echo "âŒ VITE_CLERK_PUBLISHABLE_KEY"
          [ ! -z "${{ secrets.CLERK_SECRET_KEY }}" ] && echo "âœ… CLERK_SECRET_KEY" || echo "âš ï¸  CLERK_SECRET_KEY (optional for builds)"
      
      - name: Test Optional Secrets
        run: |
          echo ""
          echo "ðŸ”§ Testing Optional Secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          [ ! -z "${{ secrets.STRIPE_PUBLISHABLE_KEY }}" ] && echo "âœ… STRIPE_PUBLISHABLE_KEY" || echo "âš ï¸  STRIPE_PUBLISHABLE_KEY"
          [ ! -z "${{ secrets.STRIPE_SECRET_KEY }}" ] && echo "âœ… STRIPE_SECRET_KEY" || echo "âš ï¸  STRIPE_SECRET_KEY"
          [ ! -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ] && echo "âœ… CLOUDFLARE_ZONE_ID" || echo "âš ï¸  CLOUDFLARE_ZONE_ID"
          [ ! -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] && echo "âœ… CLOUDFLARE_API_TOKEN" || echo "âš ï¸  CLOUDFLARE_API_TOKEN"
          [ ! -z "${{ secrets.SLACK_WEBHOOK }}" ] && echo "âœ… SLACK_WEBHOOK" || echo "âš ï¸  SLACK_WEBHOOK"
          [ ! -z "${{ secrets.SNYK_TOKEN }}" ] && echo "âœ… SNYK_TOKEN" || echo "âš ï¸  SNYK_TOKEN"
          [ ! -z "${{ secrets.SONAR_TOKEN }}" ] && echo "âœ… SONAR_TOKEN" || echo "âš ï¸  SONAR_TOKEN"
      
      - name: Test Build with Secrets
        run: |
          echo ""
          echo "ðŸ—ï¸ Testing Build Configuration..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Test if we can create a build config with secrets
          cat > test-build-config.js << EOF
          const config = {
            supabase: {
              url: process.env.VITE_SUPABASE_URL ? 'âœ… Configured' : 'âŒ Missing',
              key: process.env.VITE_SUPABASE_ANON_KEY ? 'âœ… Configured' : 'âŒ Missing'
            },
            clerk: {
              key: process.env.VITE_CLERK_PUBLISHABLE_KEY ? 'âœ… Configured' : 'âŒ Missing'
            },
            vercel: {
              token: process.env.VERCEL_TOKEN ? 'âœ… Configured' : 'âŒ Missing'
            }
          };
          console.log('Build Configuration Status:');
          console.log(JSON.stringify(config, null, 2));
          EOF
          
          VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
          VITE_SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
          VITE_CLERK_PUBLISHABLE_KEY="${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}" \
          VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}" \
          node test-build-config.js
      
      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Test Summary for ${{ github.event.inputs.environment }} environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Legend:"
          echo "  âœ… = Secret configured and available"
          echo "  âŒ = Required secret missing"
          echo "  âš ï¸  = Optional secret not configured"
          echo ""
          echo "If you see âŒ marks, please configure the missing secrets."
          echo "See docs/GITHUB_ENVIRONMENTS.md for instructions."
