# üí≥ Stripe Testing Guide - Document Safe

## üìã Obsah
1. [Prehƒæad](#prehƒæad)
2. [Testovacie prostredie](#testovacie-prostredie)
3. [Testovacie karty](#testovacie-karty)
4. [Testovanie platobn√Ωch scen√°rov](#testovanie-platobn√Ωch-scen√°rov)
5. [Testovanie webhookov](#testovanie-webhookov)
6. [Debugovanie a rie≈°enie probl√©mov](#debugovanie-a-rie≈°enie-probl√©mov)

---

## üéØ Prehƒæad

Tento dokument obsahuje kompletn√∫ pr√≠ruƒçku pre testovanie Stripe integr√°cie v Document Safe aplik√°cii. V≈°etky platby v testovacom re≈æime s√∫ simulovan√© a ≈æiadne skutoƒçn√© peniaze sa nepren√°≈°aj√∫.

### D√¥le≈æit√© URL adresy
- **Stripe Dashboard (Test Mode)**: https://dashboard.stripe.com/test/dashboard
- **Webhook Endpoint**: `https://lolnkpeipxwhhiukqboo.supabase.co/functions/v1/stripe-webhook`
- **Aplik√°cia**: http://localhost:3000/pricing (alebo v√°≈° deployment URL)

---

## üîß Testovacie prostredie

### API Kƒæ√∫ƒçe (Test Mode)
```
Publishable Key: pk_test_51RxUMeFjl1oRWeU65Io8N2kBHb5qWCz8kOTRKhHQk5Sx1M6vJVGqBi7lxVdQGLUJvNXLJfqNvtjdKuqz3N2XVb0v00hvbhKTlP
Secret Key: sk_test_51RxUMeFjl1oRWeU6boLX0xTnSSIzYdt9jcUQWUJx6FKsNX5uCqH55cqgjpYn0zayR5Y07T0XpePIM9N39CR7llo500XBtXellm
Webhook Secret: whsec_Di7yonYndLu8uCSfQIb5t4on0oobbzQZ
```

### Produkty a ceny (Test Mode)
| Pl√°n | Mesaƒçne | Roƒçne | Price ID (Mesaƒçne) | Price ID (Roƒçne) |
|------|---------|-------|-------------------|------------------|
| **Essential** | $9.99 | $99.99 | `price_1S2AU9Fjl1oRWeU60ajoUhTz` | `price_1S2AU9Fjl1oRWeU6Crewzj5D` |
| **Family** | $19.99 | $199.99 | `price_1S2AUAFjl1oRWeU6RGjCZX6S` | `price_1S2AUAFjl1oRWeU63cvXIf9o` |
| **Premium** | $39.99 | $399.99 | `price_1S2AUAFjl1oRWeU64RKuOu7B` | `price_1S2AUBFjl1oRWeU6587z8bLh` |

---

## üí≥ Testovacie karty

### Z√°kladn√© testovacie karty

#### ‚úÖ √öspe≈°n√© platby

| Scen√°r | ƒå√≠slo karty | CVC | D√°tum expir√°cie | PSƒå |
|--------|-------------|-----|-----------------|-----|
| **≈†tandardn√° √∫spe≈°n√° platba** | `4242 4242 4242 4242` | ƒΩubovoƒæn√© 3 ƒç√≠slice | ƒΩubovoƒæn√Ω bud√∫ci d√°tum | ƒΩubovoƒæn√© |
| **Visa √∫spe≈°n√°** | `4000 0566 5566 5556` | ƒΩubovoƒæn√© 3 ƒç√≠slice | ƒΩubovoƒæn√Ω bud√∫ci d√°tum | ƒΩubovoƒæn√© |
| **Mastercard √∫spe≈°n√°** | `5555 5555 5555 4444` | ƒΩubovoƒæn√© 3 ƒç√≠slice | ƒΩubovoƒæn√Ω bud√∫ci d√°tum | ƒΩubovoƒæn√© |
| **American Express** | `3782 822463 10005` | ƒΩubovoƒæn√© 4 ƒç√≠slice | ƒΩubovoƒæn√Ω bud√∫ci d√°tum | ƒΩubovoƒæn√© |

#### üîê 3D Secure autentifik√°cia

| Scen√°r | ƒå√≠slo karty | V√Ωsledok |
|--------|-------------|----------|
| **Vy≈æaduje autentifik√°ciu** | `4000 0025 0000 3155` | Zobraz√≠ 3D Secure v√Ωzvu, potom √∫spech |
| **V≈ædy vy≈æaduje autentifik√°ciu** | `4000 0027 6000 3184` | V≈ædy vy≈æaduje 3D Secure |
| **Autentifik√°cia zlyh√°** | `4000 0082 6000 3178` | 3D Secure zlyh√° |

#### ‚ùå Zamietnut√© karty

| Scen√°r | ƒå√≠slo karty | D√¥vod zamietnutia |
|--------|-------------|-------------------|
| **V≈°eobecn√© zamietnutie** | `4000 0000 0000 0002` | Karta zamietnut√° |
| **Nedostatoƒçn√© prostriedky** | `4000 0000 0000 9995` | Nedostatok prostriedkov |
| **Straten√° karta** | `4000 0000 0000 9987` | Karta nahl√°sen√° ako straten√° |
| **Ukradnut√° karta** | `4000 0000 0000 9979` | Karta nahl√°sen√° ako ukradnut√° |
| **Expirovan√° karta** | `4000 0000 0000 0069` | Karta expirovala |
| **Nespr√°vne CVC** | `4000 0000 0000 0127` | CVC kontrola zlyhala |
| **Nespr√°vne PSƒå** | `4000 0000 0000 0036` | PSƒå kontrola zlyhala |
| **Vysok√© riziko** | `4000 0000 0000 6975` | Platba oznaƒçen√° ako rizikov√° |

### ≈†pecifick√© testovacie scen√°re

#### üîÑ Predplatn√© scen√°re

1. **√öspe≈°n√© vytvorenie predplatn√©ho**
   - Karta: `4242 4242 4242 4242`
   - Kroky:
     1. Choƒè na `/pricing`
     2. Vyber pl√°n (Essential/Family/Premium)
     3. Vyber fakturaƒçn√Ω cyklus (mesaƒçn√Ω/roƒçn√Ω)
     4. Klikni na "Upgrade to [plan]"
     5. Zadaj testovaciu kartu
     6. Potvrƒè platbu

2. **Predplatn√© s 3D Secure**
   - Karta: `4000 0025 0000 3155`
   - Rovnak√© kroky ako vy≈°≈°ie, ale bude vy≈æadovan√° dodatoƒçn√° autentifik√°cia

3. **Zlyhanie prvej platby**
   - Karta: `4000 0000 0000 0341`
   - Prv√° platba zlyh√°, ale karta sa ulo≈æ√≠ pre bud√∫ce pokusy

#### üí∏ Obnovenie predplatn√©ho

| Scen√°r | Karta pre test | Simul√°cia |
|--------|---------------|-----------|
| **√öspe≈°n√© obnovenie** | `4242 4242 4242 4242` | Automatick√© obnovenie prebehne √∫spe≈°ne |
| **Zlyhanie obnovenia** | `4000 0000 0000 0341` | Obnovenie zlyh√°, predplatn√© prejde do `past_due` |
| **Retry √∫spe≈°n√Ω** | `4000 0000 0000 0119` | Prv√Ω pokus zlyh√°, druh√Ω √∫spe≈°n√Ω |

---

## üß™ Testovanie platobn√Ωch scen√°rov

### 1. Nov√° registr√°cia s predplatn√Ωm

```bash
# Krok 1: Registr√°cia pou≈æ√≠vateƒæa
1. Vytvor nov√Ω √∫ƒçet na /signup
2. Potvrƒè email (ak je vy≈æadovan√Ω)
3. Prihl√°s sa

# Krok 2: V√Ωber pl√°nu
4. Naviguj na /pricing
5. Vyber ≈æelan√Ω pl√°n
6. Klikni na "Upgrade to [plan]"

# Krok 3: Platba
7. Zadaj testovaciu kartu: 4242 4242 4242 4242
8. Expir√°cia: 12/34
9. CVC: 123
10. PSƒå: 12345
11. Klikni "Subscribe"

# Oƒçak√°van√Ω v√Ωsledok:
- Redirect na success page
- Predplatn√© akt√≠vne v datab√°ze
- Webhook spracovan√Ω
```

### 2. Upgrade existuj√∫ceho pl√°nu

```bash
# Pre pou≈æ√≠vateƒæa s Essential pl√°nom
1. Prihl√°s sa ako pou≈æ√≠vateƒæ s Essential
2. Choƒè na /pricing
3. Vyber Family alebo Premium
4. Dokonƒç√≠ checkout proces

# Oƒçak√°van√Ω v√Ωsledok:
- Pl√°n sa okam≈æite upgraduje
- Prorate sa vypoƒç√≠ta automaticky
- Nov√© limity s√∫ okam≈æite dostupn√©
```

### 3. Testovanie limitov (Freemium)

```javascript
// Test script pre overenie limitov
const testLimits = async () => {
  // 1. Free u≈æ√≠vateƒæ
  const canAddDocument = await subscriptionService.checkUsageLimit('documents');
  console.log('Free user can add document:', canAddDocument);
  
  // 2. Pridanie dokumentu
  const added = await subscriptionService.incrementUsage('documents', 1);
  console.log('Document added:', added);
  
  // 3. Kontrola vyu≈æitia
  const usage = await subscriptionService.getUsagePercentage('documents');
  console.log('Usage percentage:', usage + '%');
};
```

### 4. Zru≈°enie predplatn√©ho

```bash
# Cez Customer Portal
1. Prihl√°s sa ako platen√Ω pou≈æ√≠vateƒæ
2. Choƒè na /account/billing
3. Klikni "Manage Subscription"
4. Vyber "Cancel Subscription"

# Oƒçak√°van√Ω v√Ωsledok:
- Predplatn√© zost√°va akt√≠vne do konca obdobia
- Status sa zmen√≠ na 'cancelled'
- Po expir√°cii sa vr√°ti na Free pl√°n
```

---

## üîî Testovanie webhookov

### Manu√°lne testovanie webhookov

1. **Stripe CLI** (odpor√∫ƒçan√©)
```bash
# In≈°tal√°cia Stripe CLI
brew install stripe/stripe-cli/stripe

# Prihl√°senie
stripe login

# Forward webhooks lok√°lne
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Trigger test webhook
stripe trigger checkout.session.completed
```

2. **Cez Stripe Dashboard**
- Choƒè na https://dashboard.stripe.com/test/webhooks
- Vyber tvoj webhook endpoint
- Klikni "Send test webhook"
- Vyber event type
- Odo≈°li

### Webhook Events pre testovanie

| Event | Trigger | Oƒçak√°van√Ω v√Ωsledok |
|-------|---------|-------------------|
| `checkout.session.completed` | √öspe≈°n√© dokonƒçenie checkout | Vytvor√≠ sa z√°znam predplatn√©ho |
| `customer.subscription.updated` | Zmena pl√°nu | Aktualizuje sa pl√°n v DB |
| `customer.subscription.deleted` | Zru≈°enie predplatn√©ho | Pou≈æ√≠vateƒæ sa vr√°ti na Free |
| `invoice.payment_succeeded` | √öspe≈°n√° platba | Status = active |
| `invoice.payment_failed` | Zlyhanie platby | Status = past_due |

### Overenie webhook logu

```sql
-- Supabase SQL Editor
-- Kontrola posledn√Ωch webhook spracovan√≠
SELECT * FROM user_subscriptions 
ORDER BY updated_at DESC 
LIMIT 10;

-- Kontrola pou≈æ√≠vateƒæsk√©ho vyu≈æitia
SELECT * FROM user_usage 
WHERE user_id = '[user_id]';
```

---

## üêõ Debugovanie a rie≈°enie probl√©mov

### ƒåast√© probl√©my a rie≈°enia

#### 1. "No such price" error
```bash
# Probl√©m: Price ID neexistuje
# Rie≈°enie: Spusti setup script
node scripts/setup-stripe-products.js
```

#### 2. Webhook signature verification failed
```bash
# Probl√©m: Nespr√°vny webhook secret
# Rie≈°enie: Aktualizuj secret v Supabase
npx supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
npx supabase functions deploy stripe-webhook
```

#### 3. Subscription not updating
```sql
-- Skontroluj ƒçi existuje pou≈æ√≠vateƒæ
SELECT * FROM user_subscriptions WHERE user_id = '[user_id]';

-- Skontroluj webhook logy v Stripe Dashboard
-- https://dashboard.stripe.com/test/webhooks/[webhook_id]/attempts
```

### Debug n√°stroje

#### 1. Test integr√°cie script
```bash
node scripts/test-stripe-integration.js
```

#### 2. Stripe Dashboard n√°stroje
- **Events & Logs**: https://dashboard.stripe.com/test/events
- **Webhook attempts**: https://dashboard.stripe.com/test/webhooks
- **Customer list**: https://dashboard.stripe.com/test/customers
- **Subscription list**: https://dashboard.stripe.com/test/subscriptions

#### 3. Supabase Dashboard
- **Table Editor**: Kontrola `user_subscriptions` a `user_usage`
- **Functions Logs**: Kontrola Edge Function logov
- **SQL Editor**: Custom queries pre debugging

### Logging a monitoring

```javascript
// Pridaj logging do k√≥du pre debugging
console.log('Creating checkout session for user:', userId);
console.log('Price ID:', priceId);
console.log('Metadata:', { user_id: userId });

// V Edge Functions
console.log('Webhook received:', event.type);
console.log('Processing for user:', userId);
```

---

## üìä Testovacia matica

| Funkcia | Free | Essential | Family | Premium | Testovan√° |
|---------|------|-----------|--------|---------|-----------|
| Max dokumentov | 100 | 1,000 | 5,000 | ‚àû | ‚¨ú |
| Max √∫lo≈æisko | 500 MB | 5 GB | 20 GB | ‚àû | ‚¨ú |
| Time Capsules | 1 | 5 | 20 | ‚àû | ‚¨ú |
| Skeny/mesiac | 10 | 100 | 500 | ‚àû | ‚¨ú |
| Rodinn√≠ ƒçlenovia | 1 | 1 | 5 | 10 | ‚¨ú |
| Offline pr√≠stup | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚¨ú |
| AI funkcie | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚¨ú |
| Pokroƒçil√© vyhƒæad√°vanie | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚¨ú |
| Prioritn√° podpora | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚¨ú |

---

## üìù Testovac√≠ checklist

### Pre ka≈æd√Ω release:
- [ ] Test nov√©ho predplatn√©ho (v≈°etky pl√°ny)
- [ ] Test upgrade pl√°nu
- [ ] Test downgrade pl√°nu
- [ ] Test zru≈°enia predplatn√©ho
- [ ] Test 3D Secure autentifik√°cie
- [ ] Test zlyhan√Ωch platieb
- [ ] Test webhook spracovania
- [ ] Test limitov pre ka≈æd√Ω pl√°n
- [ ] Test Customer Portal pr√≠stupu
- [ ] Test obnovenia predplatn√©ho

---

## üîó U≈æitoƒçn√© odkazy

- [Stripe Testing Documentation](https://stripe.com/docs/testing)
- [Stripe Test Cards Reference](https://stripe.com/docs/testing#cards)
- [Stripe Webhook Events](https://stripe.com/docs/webhooks/stripe-events)
- [Stripe CLI Documentation](https://stripe.com/docs/stripe-cli)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

---

## üìû Kontakt pre podporu

Ak naraz√≠≈° na probl√©my s testovan√≠m:
1. Skontroluj t√∫to dokument√°ciu
2. Pozri sa do Stripe Dashboard logov
3. Skontroluj Supabase Function logy
4. Pou≈æij debug scripty v `/scripts`

---

*Posledn√° aktualiz√°cia: 31.8.2025*
